<!DOCTYPE html>
<html>
<head>
  <title>QR Code Scanner</title>
  <script src="https://unpkg.com/jsqr"></script>
</head>
<body>
  <h2>Scan a QR Code</h2>
  
  <label for="cameraSelect">Choose Camera:</label>
  <select id="cameraSelect"></select>

  <video id="qr-video" width="100%" height="300" autoplay playsinline style="display: block !important; opacity: 1 !important; background-color: black;"></video>
  <canvas id="qr-canvas"></canvas>
  <p id="result">Scanning...</p>

  <script>
    const video = document.getElementById("qr-video");
    const canvas = document.getElementById("qr-canvas");
    const ctx = canvas.getContext("2d");
    const resultText = document.getElementById("result");
    const cameraSelect = document.getElementById("cameraSelect");

    // ‚úÖ Step 1: Get Camera List
    async function getCameras() {
      try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoDevices = devices.filter(device => device.kind === "videoinput");

        if (videoDevices.length > 0) {
          videoDevices.forEach((device, index) => {
            const option = document.createElement("option");
            option.value = device.deviceId;
            option.text = device.label || `Camera ${index + 1}`;
            cameraSelect.appendChild(option);
          });

          cameraSelect.addEventListener("change", () => {
            startCamera(cameraSelect.value);
          });

          startCamera(videoDevices[0].deviceId);
        } else {
          resultText.innerText = "‚ùå No cameras detected!";
        }
      } catch (error) {
        console.error("Error fetching camera devices:", error);
        resultText.innerText = "‚ùå Camera not accessible!";
      }
    }

    // ‚úÖ Step 2: Start Camera
    async function startCamera(deviceId = null) {
      try {
        const constraints = {
          video: deviceId ? { deviceId: { exact: deviceId } } : { facingMode: "user" }
        };
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
        console.log("‚úÖ Camera started successfully!");
      } catch (error) {
        console.error("‚ùå Camera error:", error);
        resultText.innerText = "‚ùå Cannot access camera!";
      }
    }

    // ‚úÖ Step 3: Auto Restart Camera If Not Showing Video
    function restartCamera() {
      console.warn("‚ö†Ô∏è Camera not sending video, restarting...");
      video.srcObject = null; // Stop existing stream
      navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } })
        .then(stream => {
          video.srcObject = stream;
          console.log("‚úÖ Camera restarted successfully!");
        })
        .catch(error => {
          console.error("‚ùå Camera restart error:", error);
          resultText.innerText = "‚ùå Could not restart camera!";
        });
    }

    // If the video is not showing, restart the camera after 3 seconds
    setTimeout(() => {
      if (video.videoWidth === 0 || video.videoHeight === 0) {
        restartCamera();
      }
    }, 3000);

    // ‚úÖ Step 4: Detect QR Code in Camera Feed
    video.addEventListener("loadeddata", function() {
  setInterval(() => {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

    console.log("üì∏ Capturing video frame for QR detection..."); // Debugging log

    const code = jsQR(imageData.data, imageData.width, imageData.height);

    if (code) {
      console.log("üì∏ Scanned QR Code Data:", code.data); // Debugging log
      let scannedNumber = code.data.match(/\d{6}/); // Extract 6-digit number
      if (scannedNumber) {
        sendToGoogleAppsScript(scannedNumber[0]);
      }
    } else {
      console.warn("‚ö†Ô∏è No QR code detected.");
    }
  }, 2000);
});

    // ‚úÖ Step 5: Send Scanned QR Code to Google Apps Script
    function sendToGoogleAppsScript(qrData) {
      console.log("üì° Sending QR Data:", qrData); // Debugging log

      const scriptURL = "https://script.google.com/macros/s/AKfycbwLE_mqTur18wZzZOy9gMTmGucZC6mBoWo1xaCxCk1T97nfzTfh79M-5YBY13qh6Ixtow/exec"; // Replace with your Google Apps Script URL
      fetch(scriptURL + "?qrData=" + encodeURIComponent(qrData))
        .then(response => response.text())
        .then(data => {
          console.log("üì° Response from server:", data); // Debugging log
          resultText.innerText = data; // Show result on page
        })
        .catch(error => {
          console.error("‚ùå Error sending QR data:", error);
          resultText.innerText = "‚ùå Failed to check QR!";
        });
    }

    // Start process
    getCameras(); // Load available cameras on page load
  </script>
</body>
</html>

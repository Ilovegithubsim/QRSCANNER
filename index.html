<!DOCTYPE html>
<html>
<head>
  <title>QR Code Scanner</title>
  <script src="https://unpkg.com/jsqr"></script>
</head>
<body>
  <h2>Scan a QR Code</h2>
  
  <label for="cameraSelect">Choose Camera:</label>
  <select id="cameraSelect"></select>

  <video id="qr-video" width="100%" height="300" autoplay playsinline style="display: block !important; opacity: 1 !important; background-color: black;"></video>
  <canvas id="qr-canvas"></canvas>
  <p id="result">Scanning...</p>

  <script>
    const video = document.getElementById("qr-video");
    const canvas = document.getElementById("qr-canvas");
    const ctx = canvas.getContext("2d");
    const resultText = document.getElementById("result");
    const cameraSelect = document.getElementById("cameraSelect");

    async function getCameras() {
      try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoDevices = devices.filter(device => device.kind === "videoinput");

        if (videoDevices.length > 0) {
          videoDevices.forEach((device, index) => {
            const option = document.createElement("option");
            option.value = device.deviceId;
            option.text = device.label || `Camera ${index + 1}`;
            cameraSelect.appendChild(option);
          });

          cameraSelect.addEventListener("change", () => {
            startCamera(cameraSelect.value);
          });

          startCamera(videoDevices[0].deviceId);
        } else {
          resultText.innerText = "❌ No cameras detected!";
        }
      } catch (error) {
        console.error("Error fetching camera devices:", error);
        resultText.innerText = "❌ Camera not accessible!";
      }
    }

    async function startCamera(deviceId = null) {
      try {
        const constraints = {
          video: deviceId ? { deviceId: { exact: deviceId } } : { facingMode: "user" }
        };
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
        console.log("✅ Camera started successfully!");
      } catch (error) {
        console.error("❌ Camera error:", error);
        resultText.innerText = "❌ Cannot access camera!";
      }
    }

    // ✅ Add Restart Camera Function
    function restartCamera() {
      console.warn("⚠️ Camera not sending video, restarting...");
      video.srcObject = null; // Stop existing stream
      navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } })
        .then(stream => {
          video.srcObject = stream;
          console.log("✅ Camera restarted successfully!");
        })
        .catch(error => {
          console.error("❌ Camera restart error:", error);
          resultText.innerText = "❌ Could not restart camera!";
        });
    }

    // ✅ Auto-Restart Camera If Video Fails to Load
    setTimeout(() => {
      if (video.videoWidth === 0 || video.videoHeight === 0) {
        restartCamera();
      }
    }, 3000);

    getCameras(); // Load available cameras on page load
  </script>
</body>
</html>
